\begin{vdmpp}[breaklines=true]
class BuyInPortugal
types
 public Category = seq of char;
 public Subcategory = seq of char;
 public AdminCode = seq of char;

instance variables
 public categories : set of Category := {};
 public subcategories : map Subcategory to Category := { |-> };
 public manufacturers : map Manufacturer`Name to Manufacturer := { |-> };
 public products : map Product`Title to Product := { |-> };
 public clients : map Client`Email to Client := { |-> };
 
 public adminCode : AdminCode := [];
 
 -- subcategories should be associated with category
  inv rng subcategories subset categories;

operations
 /** ADMIN OPERATIONS **/
 
(*@
\label{BuyInPortugal:22}
@*)
 public BuyInPortugal: () ==> BuyInPortugal
 BuyInPortugal() ==
  return self;
 
 -- Change admin password
(*@
\label{setAdminCode:27}
@*)
 public setAdminCode: AdminCode * AdminCode ==> ()
 setAdminCode(curCode, nextCode) ==
  adminCode := (*@\vdmnotcovered{nextCode}@*)
 pre curCode <> (*@\vdmnotcovered{nextCode}@*)
  (*@\vdmnotcovered{and}@*) (*@\vdmnotcovered{curCode}@*) = (*@\vdmnotcovered{adminCode}@*);
 
 -- Register manufacturer
(*@
\label{registerManufacturer:34}
@*)
 public registerManufacturer: Manufacturer`Name * AdminCode ==> ()
 registerManufacturer(name, code) == (
  dcl m:Manufacturer := new Manufacturer(name);
  addManufacturer(m);
 )
 pre name not in set dom manufacturers
  and code = adminCode
 post dom manufacturers = dom manufacturers~ union {name};

(*@
\label{addManufacturer:43}
@*)
 private addManufacturer: Manufacturer ==> ()
 addManufacturer(m) == (
  manufacturers := manufacturers munion { m.name |-> m };
 );
 
 -- Add category
(*@
\label{addCategory:49}
@*)
 public addCategory: Category * AdminCode ==> ()
 addCategory(category, code) == (
  categories := categories union {category};
 )
 pre category not in set categories
  and code = adminCode
 post categories = categories~ union {category};
 
 -- Set categories
(*@
\label{setCategories:58}
@*)
 public setCategories: set of Category * AdminCode ==> ()
 setCategories(cats, code) == (
  categories := cats;
 )
 pre code = adminCode;
 
 -- Add subCategories
(*@
\label{addSubcategory:65}
@*)
 public addSubcategory: Subcategory * Category * AdminCode ==> ()
 addSubcategory(subcategory, category, code) == (
  subcategories := subcategories munion {subcategory |-> category};
 )
 pre subcategory not in set dom subcategories
  and category in set categories
  and code = adminCode
 post dom subcategories = dom subcategories~ union {subcategory};
 
 -- Set subCategories
(*@
\label{setSubcategories:75}
@*)
 public setSubcategories: map Subcategory to Category * AdminCode ==> ()
 setSubcategories(subcats, code) == (
  subcategories := subcats;
 )
 pre code = adminCode;
 
 /** ADMIN OPERATIONS END **/
 
 
 /** MANUFACTURER OPERATIONS **/
 
 -- Add product
(*@
\label{addProduct:87}
@*)
 public addProduct: Manufacturer`Name * Product`Title * Product`Description * Product`Subcategory * Product`Price * map Product`Color to Product`Quantity ==> ()
 addProduct(manName, tit, des, cat, pr, qties) == (
  dcl product : Product := new Product(tit, des, cat, pr, qties);
  let manufacturer = manufacturers(manName)
   in (
    manufacturer.addProduct(product);
    products := products munion {tit |-> product};
   );
   return;
 )
 pre manName in set dom manufacturers
  and tit not in set dom products
  and cat in set dom subcategories
 post dom products = dom products~ union {tit};
 
 -- Add to stock of a product
(*@
\label{addToStock:103}
@*)
 public addToStock: Manufacturer`Name * Product`Title * Product`Color * Product`Quantity ==> ()
 addToStock(manName, title, color, qty) == (
  let product = products(title)
  in (
   product.addToStock(color, qty);
  );
 )
 pre title in set dom manufacturers(manName).products;
 
 -- Remove from stock of a product
(*@
\label{removeFromStock:113}
@*)
 public removeFromStock: Manufacturer`Name * Product`Title * Product`Color * Product`Quantity ==> ()
 removeFromStock(manName, title, color, qty) == (*@\vdmnotcovered{(}@*)
  (*@\vdmnotcovered{let}@*) product = products((*@\vdmnotcovered{title}@*))
  in (*@\vdmnotcovered{(}@*)
   product.removeFromStock((*@\vdmnotcovered{color}@*), (*@\vdmnotcovered{qty}@*));
  );
 )
 pre title in set (*@\vdmnotcovered{dom}@*) manufacturers(manName).(*@\vdmnotcovered{products}@*);
 
 /** MANUFACTURER OPERATIONS END **/


 /** CLIENT OPERATIONS **/
 
 -- Add to wishlist of a client
(*@
\label{addToWishlist:128}
@*)
 public addToWishlist: Client`Email * Product`Title * Product`Color ==> ()
 addToWishlist(email, title, color) == (
  let client = clients(email)
  in (
   client.addToWishlist(title, color);
  );
 );
 
 -- Remove from wishlist of a client
(*@
\label{removeFromWishlist:137}
@*)
 public removeFromWishlist: Client`Email * Product`Title * Product`Color ==> ()
 removeFromWishlist(email, title, color) == (
  let client = clients(email)
  in (
   client.removeFromWishlist(title, color);
  );
 );
 
 -- Add to cart of a client
(*@
\label{addToCart:146}
@*)
 public addToCart: Client`Email * Product`Title * Product`Color ==> ()
 addToCart(email, title, color) == (
  let client = clients(email)
  in (
   client.addToCart(title, color);
  );
 );
 
 -- Set quantity from cart product of a client
(*@
\label{setQtyInCart:155}
@*)
 public setQtyInCart: Client`Email * Product`Title * Product`Color * Product`Quantity ==> ()
 setQtyInCart(email, title, color, qty) == (
  let client = clients(email)
  in (
   client.setQtyInCart(title, color, qty);
  );
 );
 
 -- Remove from cart of a client
(*@
\label{removeFromCart:164}
@*)
 public removeFromCart: Client`Email * Product`Title * Product`Color ==> ()
 removeFromCart(email, title, color) == (
  let client = clients(email)
  in (
   client.removeFromCart(title, color);
  );
 );
 
 -- Get total cart value
(*@
\label{getTotalCart:173}
@*)
 public getTotalCart: Client`Email ==> rat
 getTotalCart(email) == (
  dcl sum: rat := 0;
  let client = clients(email), cart = client.cart
  in (
   for all mk_(title, color) in set dom cart
    do (let qty = cart(mk_(title, color))
     in sum := sum + products(title).getPriceWithDiscount(qty) * qty;
    );
   return sum;
  );
 );
 
 -- Buy cart from client
(*@
\label{buy:187}
@*)
 public buy: Client`Email ==> ()
 buy(email) == (
  let client = clients(email), cart = client.cart
  in (
   for all mk_(title, color) in set dom cart
    do (
     products(title).removeFromStock(color, cart(mk_(title, color)))
    );
   client.pushCartToHistory();
  );
 )
 pre let client = clients(email), cart = client.cart
  in (
   forall mk_(title, color) in set dom cart
    & cart(mk_(title, color)) <= products(title).quantities(color)
  );
 
 -- Convert wishlist of a client
(*@
\label{convertWishlist:205}
@*)
 public convertWishlist: Client`Email ==> ()
 convertWishlist(email) == (
  let client = clients(email)
  in (
   client.convertWishlist();
  );
 );
 
 /** CLIENT OPERATIONS END **/
 
 
 /** VISITOR OPERATIONS **/
 
 -- Register client
(*@
\label{registerClient:219}
@*)
 public registerClient: Client`Email ==> ()
 registerClient(email) == (
 dcl c:Client := new Client(email);
  addClient(c);
 )
 pre email not in set dom clients
 post dom clients = dom clients~ union {email};

(*@
\label{addClient:227}
@*)
 private addClient: Client ==> ()
 addClient(c) == (
  clients := clients munion { c.email |-> c };
 );
 
 -- Get product by title
(*@
\label{searchProductsByTitle:233}
@*)
 public searchProductsByTitle: Product`Title ==> Product
 searchProductsByTitle(title) == (*@\vdmnotcovered{(}@*)
  dcl product: Product;
  (*@\vdmnotcovered{product}@*) := products((*@\vdmnotcovered{title}@*));
  return (*@\vdmnotcovered{product}@*);
 );
 
  -- Get products by manufacturer
(*@
\label{searchProductsByManufacturer:241}
@*)
 public searchProductsByManufacturer: Manufacturer`Name ==> set of Product
 searchProductsByManufacturer(man) == (*@\vdmnotcovered{(}@*)
  dcl resultPoducts: set of Product := (*@\vdmnotcovered{\{}@*)};
  resultPoducts := rng manufacturers((*@\vdmnotcovered{man}@*)).(*@\vdmnotcovered{products}@*);
  (*@\vdmnotcovered{return}@*) (*@\vdmnotcovered{resultPoducts}@*);
 )
 pre man (*@\vdmnotcovered{in}@*) set (*@\vdmnotcovered{dom}@*) (*@\vdmnotcovered{manufacturers}@*);
 
 -- Get products by subcategory
(*@
\label{searchProductBySubcategory:250}
@*)
 public searchProductBySubcategory: Subcategory ==> set of Product
 searchProductBySubcategory(subcat) == (*@\vdmnotcovered{(}@*)
  dcl resultProducts: set of Product := (*@\vdmnotcovered{\{}@*)};
  for all product in set (*@\vdmnotcovered{rng}@*) (*@\vdmnotcovered{products}@*)
   do (*@\vdmnotcovered{(}@*)
    if product.(*@\vdmnotcovered{subcategory}@*) = (*@\vdmnotcovered{subcat}@*)
    then resultProducts := resultProducts (*@\vdmnotcovered{union}@*) {(*@\vdmnotcovered{product}@*)};
   );
  (*@\vdmnotcovered{return}@*) (*@\vdmnotcovered{resultProducts}@*);
 )
 pre subcat (*@\vdmnotcovered{in}@*) set dom (*@\vdmnotcovered{subcategories}@*);
 
 
 -- Get products by category
(*@
\label{searchProductByCategory:264}
@*)
 public searchProductByCategory: Category ==> set of Product
 searchProductByCategory(cat) == (*@\vdmnotcovered{(}@*)
  dcl resultProducts: set of Product := (*@\vdmnotcovered{\{}@*)};
  for all product in set rng (*@\vdmnotcovered{products}@*)
   do (*@\vdmnotcovered{(}@*)
    if (*@\vdmnotcovered{subcategories}@*)((*@\vdmnotcovered{product}@*).(*@\vdmnotcovered{subcategory}@*)) = (*@\vdmnotcovered{cat}@*)
    then resultProducts := resultProducts union {(*@\vdmnotcovered{product}@*)};
   );
  return (*@\vdmnotcovered{resultProducts}@*);
 )
 pre cat in set (*@\vdmnotcovered{categories}@*);
 /** VISITOR OPERATIONS END **/
 
end BuyInPortugal
\end{vdmpp}
\bigskip
\begin{longtable}{|l|r|r|r|}
\hline
Function or operation & Line & Coverage & Calls \\
\hline
\hline
\hyperref[BuyInPortugal:22]{BuyInPortugal} & 22&100.0\% & 117 \\
\hline
\hyperref[addCategory:49]{addCategory} & 49&100.0\% & 78 \\
\hline
\hyperref[addClient:227]{addClient} & 227&100.0\% & 52 \\
\hline
\hyperref[addManufacturer:43]{addManufacturer} & 43&100.0\% & 67 \\
\hline
\hyperref[addProduct:87]{addProduct} & 87&100.0\% & 47 \\
\hline
\hyperref[addSubcategory:65]{addSubcategory} & 65&100.0\% & 50 \\
\hline
\hyperref[addToCart:146]{addToCart} & 146&100.0\% & 34 \\
\hline
\hyperref[addToStock:103]{addToStock} & 103&100.0\% & 49 \\
\hline
\hyperref[addToWishlist:128]{addToWishlist} & 128&100.0\% & 49 \\
\hline
\hyperref[buy:187]{buy} & 187&100.0\% & 13 \\
\hline
\hyperref[convertWishlist:205]{convertWishlist} & 205&100.0\% & 16 \\
\hline
\hyperref[getTotalCart:173]{getTotalCart} & 173&100.0\% & 15 \\
\hline
\hyperref[registerClient:219]{registerClient} & 219&100.0\% & 52 \\
\hline
\hyperref[registerManufacturer:34]{registerManufacturer} & 34&100.0\% & 67 \\
\hline
\hyperref[removeFromCart:164]{removeFromCart} & 164&100.0\% & 30 \\
\hline
\hyperref[removeFromStock:113]{removeFromStock} & 113&0.0\% & 0 \\
\hline
\hyperref[removeFromWishlist:137]{removeFromWishlist} & 137&100.0\% & 15 \\
\hline
\hyperref[searchProductByCategory:264]{searchProductByCategory} & 264&0.0\% & 0 \\
\hline
\hyperref[searchProductBySubcategory:250]{searchProductBySubcategory} & 250&0.0\% & 0 \\
\hline
\hyperref[searchProductsByManufacturer:241]{searchProductsByManufacturer} & 241&0.0\% & 0 \\
\hline
\hyperref[searchProductsByTitle:233]{searchProductsByTitle} & 233&0.0\% & 0 \\
\hline
\hyperref[setAdminCode:27]{setAdminCode} & 27&0.0\% & 0 \\
\hline
\hyperref[setCategories:58]{setCategories} & 58&100.0\% & 46 \\
\hline
\hyperref[setQtyInCart:155]{setQtyInCart} & 155&100.0\% & 18 \\
\hline
\hyperref[setSubcategories:75]{setSubcategories} & 75&100.0\% & 39 \\
\hline
\hline
BuyInPortugal.vdmpp & & 77.3\% & 854 \\
\hline
\end{longtable}

