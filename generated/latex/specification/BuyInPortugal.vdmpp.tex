\begin{vdmpp}[breaklines=true]
class BuyInPortugal
types
 public Category = seq of char;
 public Subcategory = seq of char;
 public AdminCode = seq of char;

instance variables
 public categories : set of Category := {};
 public subcategories : map Subcategory to Category := { |-> };
 public manufacturers : map Manufacturer`Name to Manufacturer := { |-> };
 public products : map Product`Title to Product := { |-> };
 public clients : map Client`Email to Client := { |-> };
 
 public adminCode : AdminCode := [];
 
 -- subcategories should be associated with category
  inv rng subcategories subset categories;

operations
 /** ADMIN OPERATIONS **/
 
(*@
\label{BuyInPortugal:22}
@*)
 public BuyInPortugal: () ==> BuyInPortugal
 BuyInPortugal() ==
  return self;
 
 -- Change admin password
(*@
\label{setAdminCode:27}
@*)
 public setAdminCode: AdminCode * AdminCode ==> ()
 setAdminCode(curCode, nextCode) ==
  adminCode := nextCode
 pre curCode <> nextCode
  and curCode = adminCode;
 
 -- Register manufacturer
(*@
\label{registerManufacturer:34}
@*)
 public registerManufacturer: Manufacturer`Name * AdminCode ==> ()
 registerManufacturer(name, code) == (
  dcl m:Manufacturer := new Manufacturer(name);
  addManufacturer(m);
 )
 pre name not in set dom manufacturers
  and code = adminCode
 post dom manufacturers = dom manufacturers~ union {name};

(*@
\label{addManufacturer:43}
@*)
 private addManufacturer: Manufacturer ==> ()
 addManufacturer(m) == (
  manufacturers := manufacturers munion { m.name |-> m };
 );
 
 -- Add category
(*@
\label{addCategory:49}
@*)
 public addCategory: Category * AdminCode ==> ()
 addCategory(category, code) == (
  categories := categories union {category};
 )
 pre category not in set categories
  and code = adminCode
 post categories = categories~ union {category};
 
 -- Set categories
(*@
\label{setCategories:58}
@*)
 public setCategories: set of Category * AdminCode ==> ()
 setCategories(cats, code) == (
  categories := cats;
 )
 pre code = adminCode;
 
 -- Add subCategories
(*@
\label{addSubcategory:65}
@*)
 public addSubcategory: Subcategory * Category * AdminCode ==> ()
 addSubcategory(subcategory, category, code) == (
  subcategories := subcategories munion {subcategory |-> category};
 )
 pre subcategory not in set dom subcategories
  and category in set categories
  and code = adminCode
 post dom subcategories = dom subcategories~ union {subcategory};
 
 -- Set subCategories
(*@
\label{setSubcategories:75}
@*)
 public setSubcategories: map Subcategory to Category * AdminCode ==> ()
 setSubcategories(subcats, code) == (
  subcategories := subcats;
 )
 pre code = adminCode;
 
 /** ADMIN OPERATIONS END **/
 
 
 /** MANUFACTURER OPERATIONS **/
 
 -- Add product
(*@
\label{addProduct:87}
@*)
 public addProduct: Manufacturer`Name * Product`Title * Product`Description * Product`Subcategory * Product`Price * map Product`Color to Product`Quantity ==> ()
 addProduct(manName, tit, des, cat, pr, qties) == (
  dcl product : Product := new Product(tit, des, cat, pr, qties);
  let manufacturer = manufacturers(manName)
   in (
    manufacturer.addProduct(product);
    products := products munion {tit |-> product};
   );
   return;
 )
 pre manName in set dom manufacturers
  and tit not in set dom products
  and cat in set dom subcategories
 post dom products = dom products~ union {tit};
 
 -- Remove product
(*@
\label{removeProduct:103}
@*)
(*@
\label{addToStock:103}
@*)
 public removeProduct: Manufacturer`Name * Product`Title ==> ()
 removeProduct(manName, title) == (
  let manufacturer = manufacturers(manName)
   in (
    manufacturer.removeProduct(title);
    products := {title} <-: products;
    for all client in set rng clients
    do (
     for all mk_(t, color) in set client.wishlist
     do (
(*@
\label{removeFromStock:113}
@*)
      if t = title then client.removeFromWishlist(t, color);
     );
     for all mk_(t, color) in set dom client.cart
     do (
      if t = title then client.removeFromCart(t, color);
     );
    );
  );
 )
 pre manName in set dom manufacturers
(*@
\label{setVolumeDiscounts:123}
@*)
  and title in set dom products
 post dom products = dom products~ \ {title};
 
 -- Add to stock of a product
 public addToStock: Manufacturer`Name * Product`Title * Product`Color * Product`Quantity ==> ()
(*@
\label{addToWishlist:128}
@*)
 addToStock(manName, title, color, qty) == (
  let product = products(title)
  in (
   product.addToStock(color, qty);
  );
 )
 pre title in set dom manufacturers(manName).products;
 
 -- Remove from stock of a product
(*@
\label{removeFromWishlist:137}
@*)
 public removeFromStock: Manufacturer`Name * Product`Title * Product`Color * Product`Quantity ==> ()
 removeFromStock(manName, title, color, qty) == (
  let product = products(title)
  in (
   product.removeFromStock(color, qty);
  );
 )
 pre title in set dom manufacturers(manName).products;
 
(*@
\label{addToCart:146}
@*)
  -- Set volume discounts
 public setVolumeDiscounts : Manufacturer`Name * Product`Title * Product`VolumeDiscounts ==> ()
 setVolumeDiscounts(manName, title, volDiscs) == (
 let product = products(title)
  in (
   product.setVolumeDiscounts(volDiscs);
  );
 )
 pre title in set dom manufacturers(manName).products;
(*@
\label{setQtyInCart:155}
@*)
 
 /** MANUFACTURER OPERATIONS END **/


 /** CLIENT OPERATIONS **/
 
 -- Add to wishlist of a client
 public addToWishlist: Client`Email * Product`Title * Product`Color ==> ()
 addToWishlist(email, title, color) == (
(*@
\label{removeFromCart:164}
@*)
  let client = clients(email)
  in (
   client.addToWishlist(title, color);
  );
 );
 
 -- Remove from wishlist of a client
 public removeFromWishlist: Client`Email * Product`Title * Product`Color ==> ()
 removeFromWishlist(email, title, color) == (
(*@
\label{getTotalCart:173}
@*)
  let client = clients(email)
  in (
   client.removeFromWishlist(title, color);
  );
 );
 
 -- Add to cart of a client
 public addToCart: Client`Email * Product`Title * Product`Color ==> ()
 addToCart(email, title, color) == (
  let client = clients(email)
  in (
   client.addToCart(title, color);
  );
 );
 
(*@
\label{buy:188}
@*)
 -- Set quantity from cart product of a client
 public setQtyInCart: Client`Email * Product`Title * Product`Color * Product`Quantity ==> ()
 setQtyInCart(email, title, color, qty) == (
  let client = clients(email)
  in (
   client.setQtyInCart(title, color, qty);
  );
 );
 
 -- Remove from cart of a client
 public removeFromCart: Client`Email * Product`Title * Product`Color ==> ()
 removeFromCart(email, title, color) == (
  let client = clients(email)
  in (
   client.removeFromCart(title, color);
  );
 );
 
(*@
\label{convertWishlist:206}
@*)
 -- Get total cart value
 public getTotalCart: Client`Email ==> rat
 getTotalCart(email) == (
  dcl sum: rat := 0;
  let client = clients(email), cart = client.cart
  in (
   for all mk_(title, color) in set dom cart
    do (let qty = cart(mk_(title, color))
     in sum := sum + products(title).getPriceWithDiscount(qty) * qty;
    );
   return sum;
  );
 )
 pre email in set dom clients;
(*@
\label{registerClient:220}
@*)
 
 -- Buy cart from client
 public buy: Client`Email ==> ()
 buy(email) == (
  let client = clients(email), cart = client.cart
  in (
   for all mk_(title, color) in set dom cart
    do (
(*@
\label{addClient:228}
@*)
     products(title).removeFromStock(color, cart(mk_(title, color)))
    );
   client.pushCartToHistory();
  );
 )
 pre let client = clients(email), cart = client.cart
(*@
\label{searchProductsByTitle:234}
@*)
  in (
   forall mk_(title, color) in set dom cart
    & cart(mk_(title, color)) <= products(title).quantities(color)
  );
 
 -- Convert wishlist of a client
 public convertWishlist: Client`Email ==> ()
 convertWishlist(email) == (
(*@
\label{searchProductsByManufacturer:242}
@*)
  let client = clients(email)
  in (
   client.convertWishlist();
  );
 );
 
 /** CLIENT OPERATIONS END **/
 
 
(*@
\label{searchProductBySubcategory:251}
@*)
 /** VISITOR OPERATIONS **/
 
 -- Register client
 public registerClient: Client`Email ==> ()
 registerClient(email) == (
 dcl c:Client := new Client(email);
  addClient(c);
 )
 pre email not in set dom clients
 post dom clients = dom clients~ union {email};

 private addClient: Client ==> ()
 addClient(c) == (
  clients := clients munion { c.email |-> c };
(*@
\label{searchProductByCategory:265}
@*)
 );
 
 -- Get product by title
 public searchProductsByTitle: Product`Title ==> Product
 searchProductsByTitle(title) == (
  dcl product: Product;
  product := products(title);
  return product;
 );
 
  -- Get products by manufacturer
 public searchProductsByManufacturer: Manufacturer`Name ==> set of Product
 searchProductsByManufacturer(man) == (
  dcl resultPoducts: set of Product := {};
  resultPoducts := rng manufacturers(man).products;
  return resultPoducts;
 )
 pre man in set dom manufacturers;
 
 -- Get products by subcategory
(*@
\label{searchProductsBySubcategory:285}
@*)
 public searchProductsBySubcategory: Subcategory ==> set of Product
 searchProductsBySubcategory(subcat) == (
  dcl resultProducts: set of Product := {};
  for all product in set rng products
   do (
    if product.subcategory = subcat
    then resultProducts := resultProducts union {product};
   );
  return resultProducts;
 )
 pre subcat in set dom subcategories;
 
 
 -- Get products by category
(*@
\label{searchProductsByCategory:299}
@*)
 public searchProductsByCategory: Category ==> set of Product
 searchProductsByCategory(cat) == (
  dcl resultProducts: set of Product := {};
  for all product in set rng products
   do (
    if subcategories(product.subcategory) = cat
    then resultProducts := resultProducts union {product};
   );
  return resultProducts;
 )
 pre cat in set categories;
 /** VISITOR OPERATIONS END **/
 
end BuyInPortugal
\end{vdmpp}
\bigskip
\begin{longtable}{|l|r|r|r|}
\hline
Function or operation & Line & Coverage & Calls \\
\hline
\hline
\hyperref[BuyInPortugal:22]{BuyInPortugal} & 22&100.0\% & 336 \\
\hline
\hyperref[addCategory:49]{addCategory} & 49&100.0\% & 274 \\
\hline
\hyperref[addClient:228]{addClient} & 228&100.0\% & 128 \\
\hline
\hyperref[addManufacturer:43]{addManufacturer} & 43&100.0\% & 234 \\
\hline
\hyperref[addProduct:87]{addProduct} & 87&100.0\% & 200 \\
\hline
\hyperref[addSubcategory:65]{addSubcategory} & 65&100.0\% & 216 \\
\hline
\hyperref[addToCart:146]{addToCart} & 146&100.0\% & 84 \\
\hline
\hyperref[addToStock:103]{addToStock} & 103&100.0\% & 179 \\
\hline
\hyperref[addToWishlist:128]{addToWishlist} & 128&100.0\% & 54 \\
\hline
\hyperref[buy:188]{buy} & 188&100.0\% & 18 \\
\hline
\hyperref[convertWishlist:206]{convertWishlist} & 206&100.0\% & 22 \\
\hline
\hyperref[getTotalCart:173]{getTotalCart} & 173&100.0\% & 55 \\
\hline
\hyperref[registerClient:220]{registerClient} & 220&100.0\% & 128 \\
\hline
\hyperref[registerManufacturer:34]{registerManufacturer} & 34&100.0\% & 234 \\
\hline
\hyperref[removeFromCart:164]{removeFromCart} & 164&100.0\% & 11 \\
\hline
\hyperref[removeFromStock:113]{removeFromStock} & 113&100.0\% & 11 \\
\hline
\hyperref[removeFromWishlist:137]{removeFromWishlist} & 137&100.0\% & 11 \\
\hline
\hyperref[removeProduct:103]{removeProduct} & 103&100.0\% & 10 \\
\hline
\hyperref[searchProductByCategory:265]{searchProductByCategory} & 265&100.0\% & 3 \\
\hline
\hyperref[searchProductBySubcategory:251]{searchProductBySubcategory} & 251&100.0\% & 1 \\
\hline
\hyperref[searchProductsByCategory:299]{searchProductsByCategory} & 299&100.0\% & 3 \\
\hline
\hyperref[searchProductsByManufacturer:242]{searchProductsByManufacturer} & 242&100.0\% & 1 \\
\hline
\hyperref[searchProductsBySubcategory:285]{searchProductsBySubcategory} & 285&100.0\% & 1 \\
\hline
\hyperref[searchProductsByTitle:234]{searchProductsByTitle} & 234&100.0\% & 1 \\
\hline
\hyperref[setAdminCode:27]{setAdminCode} & 27&100.0\% & 9 \\
\hline
\hyperref[setCategories:58]{setCategories} & 58&100.0\% & 212 \\
\hline
\hyperref[setQtyInCart:155]{setQtyInCart} & 155&100.0\% & 84 \\
\hline
\hyperref[setSubcategories:75]{setSubcategories} & 75&100.0\% & 190 \\
\hline
\hyperref[setVolumeDiscounts:123]{setVolumeDiscounts} & 123&100.0\% & 33 \\
\hline
\hline
BuyInPortugal.vdmpp & & 100.0\% & 2743 \\
\hline
\end{longtable}

