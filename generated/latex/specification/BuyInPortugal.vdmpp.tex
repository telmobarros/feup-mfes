\begin{vdmpp}[breaklines=true]
class BuyInPortugal
types
 public Category = seq of char;
 public Subcategory = seq of char;
 public AdminCode = seq of char;

instance variables
 public categories : set of Category := (*@\vdmnotcovered{\{}@*)};
 public subcategories : map Subcategory to Category := (*@\vdmnotcovered{\{}@*) |-> };
 public manufacturers : map Manufacturer`Name to Manufacturer := (*@\vdmnotcovered{\{}@*) |-> };
 public products : map Product`Title to Product := (*@\vdmnotcovered{\{}@*) |-> };
 public clients : map Client`Email to Client := (*@\vdmnotcovered{\{}@*) |-> };
 
 public adminCode : AdminCode := (*@\vdmnotcovered{[}@*)];
 
 -- subcategories should be associated with category
  inv (*@\vdmnotcovered{rng}@*) (*@\vdmnotcovered{subcategories}@*) (*@\vdmnotcovered{subset}@*) (*@\vdmnotcovered{categories}@*);

operations
 /** ADMIN OPERATIONS **/
 
(*@
\label{BuyInPortugal:22}
@*)
 public BuyInPortugal: () ==> BuyInPortugal
 BuyInPortugal() ==
  (*@\vdmnotcovered{return}@*) (*@\vdmnotcovered{self}@*);
 
 -- Change admin password
(*@
\label{setAdminCode:27}
@*)
 public setAdminCode: AdminCode * AdminCode ==> ()
 setAdminCode(curCode, nextCode) ==
  adminCode := (*@\vdmnotcovered{nextCode}@*)
 pre curCode <> (*@\vdmnotcovered{nextCode}@*)
  (*@\vdmnotcovered{and}@*) (*@\vdmnotcovered{curCode}@*) = (*@\vdmnotcovered{adminCode}@*);
 
 -- Register manufacturer
(*@
\label{registerManufacturer:34}
@*)
 public registerManufacturer: Manufacturer`Name * AdminCode ==> ()
 registerManufacturer(name, code) == (*@\vdmnotcovered{(}@*)
  dcl m:Manufacturer := new Manufacturer((*@\vdmnotcovered{name}@*));
  (*@\vdmnotcovered{addManufacturer}@*)((*@\vdmnotcovered{m}@*));
 )
 pre (*@\vdmnotcovered{name}@*) not in set dom (*@\vdmnotcovered{manufacturers}@*)
  and code = (*@\vdmnotcovered{adminCode}@*)
 post dom manufacturers = dom manufacturers~ union (*@\vdmnotcovered{\{}@*)(*@\vdmnotcovered{name}@*)};

(*@
\label{addManufacturer:43}
@*)
 private addManufacturer: Manufacturer ==> ()
 addManufacturer(m) == (*@\vdmnotcovered{(}@*)
  manufacturers := manufacturers munion { m.name (*@\vdmnotcovered{|->}@*) (*@\vdmnotcovered{m}@*) };
 );
 
 -- Add category
(*@
\label{addCategory:49}
@*)
 public addCategory: Category * AdminCode ==> ()
 addCategory(category, code) == (*@\vdmnotcovered{(}@*)
  categories := (*@\vdmnotcovered{categories}@*) (*@\vdmnotcovered{union}@*) (*@\vdmnotcovered{\{}@*)(*@\vdmnotcovered{category}@*)};
 )
 pre category (*@\vdmnotcovered{not}@*) in set (*@\vdmnotcovered{categories}@*)
  and code (*@\vdmnotcovered{=}@*) (*@\vdmnotcovered{adminCode}@*)
 post categories (*@\vdmnotcovered{=}@*) (*@\vdmnotcovered{categories}@*)~ (*@\vdmnotcovered{union}@*) (*@\vdmnotcovered{\{}@*)(*@\vdmnotcovered{category}@*)};
 
 -- Set categories
(*@
\label{setCategories:58}
@*)
 public setCategories: set of Category * AdminCode ==> ()
 setCategories(cats, code) == (*@\vdmnotcovered{(}@*)
  categories := (*@\vdmnotcovered{cats}@*);
 )
 pre (*@\vdmnotcovered{code}@*) (*@\vdmnotcovered{=}@*) (*@\vdmnotcovered{adminCode}@*);
 
 -- Add subCategories
(*@
\label{addSubcategory:65}
@*)
 public addSubcategory: Subcategory * Category * AdminCode ==> ()
 addSubcategory(subcategory, category, code) == (*@\vdmnotcovered{(}@*)
  subcategories := (*@\vdmnotcovered{subcategories}@*) (*@\vdmnotcovered{munion}@*) {(*@\vdmnotcovered{subcategory}@*) (*@\vdmnotcovered{|->}@*) (*@\vdmnotcovered{category}@*)};
 )
 pre subcategory (*@\vdmnotcovered{not}@*) in set (*@\vdmnotcovered{dom}@*) (*@\vdmnotcovered{subcategories}@*)
  and (*@\vdmnotcovered{category}@*) (*@\vdmnotcovered{in}@*) set (*@\vdmnotcovered{categories}@*)
  and code = (*@\vdmnotcovered{adminCode}@*)
 post dom (*@\vdmnotcovered{subcategories}@*) = (*@\vdmnotcovered{dom}@*) (*@\vdmnotcovered{subcategories}@*)~ (*@\vdmnotcovered{union}@*) {(*@\vdmnotcovered{subcategory}@*)};
 
 -- Set subCategories
(*@
\label{setSubcategories:75}
@*)
 public setSubcategories: map Subcategory to Category * AdminCode ==> ()
 setSubcategories(subcats, code) == (*@\vdmnotcovered{(}@*)
  (*@\vdmnotcovered{subcategories}@*) := (*@\vdmnotcovered{subcats}@*);
 )
 pre code (*@\vdmnotcovered{=}@*) (*@\vdmnotcovered{adminCode}@*);
 
 /** ADMIN OPERATIONS END **/
 
 
 /** MANUFACTURER OPERATIONS **/
 
 -- Add product
(*@
\label{addProduct:87}
@*)
 public addProduct: Manufacturer`Name * Product`Title * Product`Description * Product`Subcategory * Product`Price * map Product`Color to Product`Quantity ==> ()
 addProduct(manName, tit, des, cat, pr, qties) == (*@\vdmnotcovered{(}@*)
  dcl product : Product := new (*@\vdmnotcovered{Product}@*)(tit, des, cat, pr, (*@\vdmnotcovered{qties}@*));
  let manufacturer = (*@\vdmnotcovered{manufacturers}@*)((*@\vdmnotcovered{manName}@*))
   in (*@\vdmnotcovered{(}@*)
    (*@\vdmnotcovered{manufacturer}@*).addProduct((*@\vdmnotcovered{product}@*));
    products := (*@\vdmnotcovered{products}@*) munion {tit (*@\vdmnotcovered{|->}@*) (*@\vdmnotcovered{product}@*)};
   );
   (*@\vdmnotcovered{return}@*);
 )
 pre manName in set dom (*@\vdmnotcovered{manufacturers}@*)
  and tit not in set dom (*@\vdmnotcovered{products}@*)
  and cat in set (*@\vdmnotcovered{dom}@*) (*@\vdmnotcovered{subcategories}@*)
 post (*@\vdmnotcovered{dom}@*) (*@\vdmnotcovered{products}@*) = dom products~ union (*@\vdmnotcovered{\{}@*)(*@\vdmnotcovered{tit}@*)};
 
 -- Add to stock of a product
(*@
\label{addToStock:103}
@*)
 public addToStock: Manufacturer`Name * Product`Title * Product`Color * Product`Quantity ==> ()
 addToStock(manName, title, color, qty) == (*@\vdmnotcovered{(}@*)
  let product = (*@\vdmnotcovered{products}@*)((*@\vdmnotcovered{title}@*))
  in (*@\vdmnotcovered{(}@*)
   (*@\vdmnotcovered{product}@*).addToStock((*@\vdmnotcovered{color}@*), (*@\vdmnotcovered{qty}@*));
  );
 )
 pre title in set dom manufacturers(manName).(*@\vdmnotcovered{products}@*);
 
 -- Remove from stock of a product
(*@
\label{removeFromStock:113}
@*)
 public removeFromStock: Manufacturer`Name * Product`Title * Product`Color * Product`Quantity ==> ()
 removeFromStock(manName, title, color, qty) == (*@\vdmnotcovered{(}@*)
  (*@\vdmnotcovered{let}@*) product = products((*@\vdmnotcovered{title}@*))
  in (*@\vdmnotcovered{(}@*)
   product.removeFromStock((*@\vdmnotcovered{color}@*), (*@\vdmnotcovered{qty}@*));
  );
 )
 pre title in set (*@\vdmnotcovered{dom}@*) manufacturers(manName).(*@\vdmnotcovered{products}@*);
 
 /** MANUFACTURER OPERATIONS END **/


 /** CLIENT OPERATIONS **/
 
 -- Add to wishlist of a client
(*@
\label{addToWishlist:128}
@*)
 public addToWishlist: Client`Email * Product`Title * Product`Color ==> ()
 addToWishlist(email, title, color) == (*@\vdmnotcovered{(}@*)
  let client = clients((*@\vdmnotcovered{email}@*))
  in (*@\vdmnotcovered{(}@*)
   client.addToWishlist(title, (*@\vdmnotcovered{color}@*));
  );
 );
 
 -- Remove from wishlist of a client
(*@
\label{removeFromWishlist:137}
@*)
 public removeFromWishlist: Client`Email * Product`Title * Product`Color ==> ()
 removeFromWishlist(email, title, color) == (*@\vdmnotcovered{(}@*)
  (*@\vdmnotcovered{let}@*) client = (*@\vdmnotcovered{clients}@*)((*@\vdmnotcovered{email}@*))
  in (*@\vdmnotcovered{(}@*)
   client.removeFromWishlist(title, (*@\vdmnotcovered{color}@*));
  );
 );
 
 -- Add to cart of a client
(*@
\label{addToCart:146}
@*)
 public addToCart: Client`Email * Product`Title * Product`Color ==> ()
 addToCart(email, title, color) == (*@\vdmnotcovered{(}@*)
  let client = clients((*@\vdmnotcovered{email}@*))
  in (*@\vdmnotcovered{(}@*)
   client.addToCart(title, (*@\vdmnotcovered{color}@*));
  );
 );
 
 -- Set quantity from cart product of a client
(*@
\label{setQtyInCart:155}
@*)
 public setQtyInCart: Client`Email * Product`Title * Product`Color * Product`Quantity ==> ()
 setQtyInCart(email, title, color, qty) == (*@\vdmnotcovered{(}@*)
  (*@\vdmnotcovered{let}@*) client = (*@\vdmnotcovered{clients}@*)((*@\vdmnotcovered{email}@*))
  in (*@\vdmnotcovered{(}@*)
   client.setQtyInCart(title, color, (*@\vdmnotcovered{qty}@*));
  );
 );
 
 -- Remove from cart of a client
(*@
\label{removeFromCart:164}
@*)
 public removeFromCart: Client`Email * Product`Title * Product`Color ==> ()
 removeFromCart(email, title, color) == (*@\vdmnotcovered{(}@*)
  let client = (*@\vdmnotcovered{clients}@*)((*@\vdmnotcovered{email}@*))
  in (*@\vdmnotcovered{(}@*)
   (*@\vdmnotcovered{client}@*).removeFromCart(title, (*@\vdmnotcovered{color}@*));
  );
 );
 
 -- Get total cart value
(*@
\label{getTotalCart:173}
@*)
 public getTotalCart: Client`Email ==> rat
 getTotalCart(email) == (*@\vdmnotcovered{(}@*)
  dcl sum: rat := (*@\vdmnotcovered{0}@*);
  (*@\vdmnotcovered{let}@*) client = clients(email), cart = client.(*@\vdmnotcovered{cart}@*)
  in (*@\vdmnotcovered{(}@*)
   for all mk_(title, color) in set dom (*@\vdmnotcovered{cart}@*)
    do (let qty = cart(mk_(title, (*@\vdmnotcovered{color}@*)))
     in (*@\vdmnotcovered{sum}@*) := sum + products(title).getPriceWithDiscount((*@\vdmnotcovered{qty}@*)) * (*@\vdmnotcovered{qty}@*);
    );
   return (*@\vdmnotcovered{sum}@*);
  );
 );
 
 -- Buy cart from client
(*@
\label{buy:187}
@*)
 public buy: Client`Email ==> ()
 buy(email) == (*@\vdmnotcovered{(}@*)
  (*@\vdmnotcovered{let}@*) client = clients(email), cart = (*@\vdmnotcovered{client}@*).(*@\vdmnotcovered{cart}@*)
  in (*@\vdmnotcovered{(}@*)
   (*@\vdmnotcovered{for}@*) all mk_(title, color) in set (*@\vdmnotcovered{dom}@*) (*@\vdmnotcovered{cart}@*)
    do (*@\vdmnotcovered{(}@*)
     (*@\vdmnotcovered{products}@*)(title).removeFromStock(color, cart((*@\vdmnotcovered{mk\_}@*)((*@\vdmnotcovered{title}@*), (*@\vdmnotcovered{color}@*))))
    );
   (*@\vdmnotcovered{client}@*).pushCartToHistory();
  );
 )
 pre (*@\vdmnotcovered{let}@*) client = clients(email), cart = (*@\vdmnotcovered{client}@*).(*@\vdmnotcovered{cart}@*)
  in (
   (*@\vdmnotcovered{forall}@*) mk_(title, color) in set (*@\vdmnotcovered{dom}@*) (*@\vdmnotcovered{cart}@*)
    & (*@\vdmnotcovered{cart}@*)(mk_((*@\vdmnotcovered{title}@*), (*@\vdmnotcovered{color}@*))) (*@\vdmnotcovered{<=}@*) (*@\vdmnotcovered{products}@*)((*@\vdmnotcovered{title}@*)).(*@\vdmnotcovered{quantities}@*)((*@\vdmnotcovered{color}@*))
  );
 
 -- Convert wishlist of a client
(*@
\label{convertWishlist:205}
@*)
 public convertWishlist: Client`Email ==> ()
 convertWishlist(email) == (*@\vdmnotcovered{(}@*)
  let client = (*@\vdmnotcovered{clients}@*)((*@\vdmnotcovered{email}@*))
  in (*@\vdmnotcovered{(}@*)
   (*@\vdmnotcovered{client}@*).convertWishlist();
  );
 );
 
 /** CLIENT OPERATIONS END **/
 
 
 /** VISITOR OPERATIONS **/
 
 -- Register client
(*@
\label{registerClient:219}
@*)
 public registerClient: Client`Email ==> ()
 registerClient(email) == (*@\vdmnotcovered{(}@*)
 dcl c:Client := (*@\vdmnotcovered{new}@*) (*@\vdmnotcovered{Client}@*)((*@\vdmnotcovered{email}@*));
  addClient((*@\vdmnotcovered{c}@*));
 )
 pre email not in set dom (*@\vdmnotcovered{clients}@*)
 post dom clients = dom clients~ union {(*@\vdmnotcovered{email}@*)};

(*@
\label{addClient:227}
@*)
 private addClient: Client ==> ()
 addClient(c) == (*@\vdmnotcovered{(}@*)
  (*@\vdmnotcovered{clients}@*) := clients (*@\vdmnotcovered{munion}@*) { c.email (*@\vdmnotcovered{|->}@*) (*@\vdmnotcovered{c}@*) };
 );
 
 /** VISITOR OPERATIONS END **/
 

end BuyInPortugal
\end{vdmpp}
\bigskip
\begin{longtable}{|l|r|r|r|}
\hline
Function or operation & Line & Coverage & Calls \\
\hline
\hline
\hyperref[BuyInPortugal:22]{BuyInPortugal} & 22&0.0\% & 0 \\
\hline
\hyperref[addCategory:49]{addCategory} & 49&0.0\% & 0 \\
\hline
\hyperref[addClient:227]{addClient} & 227&0.0\% & 0 \\
\hline
\hyperref[addManufacturer:43]{addManufacturer} & 43&0.0\% & 0 \\
\hline
\hyperref[addProduct:87]{addProduct} & 87&0.0\% & 0 \\
\hline
\hyperref[addSubcategory:65]{addSubcategory} & 65&0.0\% & 0 \\
\hline
\hyperref[addToCart:146]{addToCart} & 146&0.0\% & 0 \\
\hline
\hyperref[addToStock:103]{addToStock} & 103&0.0\% & 0 \\
\hline
\hyperref[addToWishlist:128]{addToWishlist} & 128&0.0\% & 0 \\
\hline
\hyperref[buy:187]{buy} & 187&0.0\% & 0 \\
\hline
\hyperref[convertWishlist:205]{convertWishlist} & 205&0.0\% & 0 \\
\hline
\hyperref[getTotalCart:173]{getTotalCart} & 173&0.0\% & 0 \\
\hline
\hyperref[registerClient:219]{registerClient} & 219&0.0\% & 0 \\
\hline
\hyperref[registerManufacturer:34]{registerManufacturer} & 34&0.0\% & 0 \\
\hline
\hyperref[removeFromCart:164]{removeFromCart} & 164&0.0\% & 0 \\
\hline
\hyperref[removeFromStock:113]{removeFromStock} & 113&0.0\% & 0 \\
\hline
\hyperref[removeFromWishlist:137]{removeFromWishlist} & 137&0.0\% & 0 \\
\hline
\hyperref[setAdminCode:27]{setAdminCode} & 27&0.0\% & 0 \\
\hline
\hyperref[setCategories:58]{setCategories} & 58&0.0\% & 0 \\
\hline
\hyperref[setQtyInCart:155]{setQtyInCart} & 155&0.0\% & 0 \\
\hline
\hyperref[setSubcategories:75]{setSubcategories} & 75&0.0\% & 0 \\
\hline
\hline
BuyInPortugal.vdmpp & & 0.0\% & 0 \\
\hline
\end{longtable}

