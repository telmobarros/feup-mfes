\begin{vdmpp}[breaklines=true]
class Product

types
 public Title = seq of char;
 public Description = seq of char;
 public Subcategory = seq of char;
 public VolumeDiscounts =  map Quantity to Price;
 public Quantity = nat;
 public Price = rat;
 public Color = <White> | <Blue> | <Pink> | <Yellow> | <Orange> | <Black> | <Purple> | <Brown> | <Green> | <Gray> | <Red> | <None> ;
 
instance variables
  public title: Title;
  public description: Description;
  public price: Price;
  public subcategory: Subcategory;
  public quantities: map Color to Quantity := { <None> |-> 0};
  public volumeDiscounts: VolumeDiscounts := { |-> };
  public colors: set of Color := {<None>};
  
  inv card colors > 1 <=> <None> not in set colors;
  inv dom quantities = colors;

operations
 -- Create product without color
(*@
\label{Product:26}
@*)
 public Product : Title * Description * Subcategory * Price  ==> Product
 Product(tit, des, cat, pr) == (*@\vdmnotcovered{(}@*)
  subcategory := (*@\vdmnotcovered{cat}@*);
   title := (*@\vdmnotcovered{tit}@*);
   description := (*@\vdmnotcovered{des}@*);
   (*@\vdmnotcovered{price}@*) := (*@\vdmnotcovered{pr}@*);
   return (*@\vdmnotcovered{self}@*);
 );
 
 -- Create product with color
 public Product : Title * Description * Subcategory * Price * map Color to Quantity ==> Product
 Product(tit, des, cat, pr, qties) == (
  subcategory := cat;
   title := tit;
   description := des;
   price := pr;
   quantities := qties;
   colors := dom qties;
   return self;
 );
  
 -- Set volume discounts
(*@
\label{setVolumeDiscounts:48}
@*)
 public setVolumeDiscounts : VolumeDiscounts ==> ()
 setVolumeDiscounts(volDiscs) == (*@\vdmnotcovered{(}@*)
  volumeDiscounts := (*@\vdmnotcovered{volDiscs}@*);
 );
 
 -- Remove from stock in products with color
(*@
\label{removeFromStock:54}
@*)
 public removeFromStock: Color * Quantity ==> ()
 removeFromStock(color, qty) == (
  quantities := quantities ++ {color |-> (quantities(color) - qty)};
 )
 pre color in set colors
  and qty <= quantities(color);
 
 -- Add to stock in products with color
(*@
\label{addToStock:62}
@*)
 public addToStock: Color * Quantity ==> ()
 addToStock(color, qty) == (
  quantities := quantities ++ {color |-> (quantities(color) + qty)};
 )
 pre color in set colors;
 
 -- Get price with discount applied
(*@
\label{getPriceWithDiscount:69}
@*)
 public getPriceWithDiscount: Quantity ==> Price 
 getPriceWithDiscount(qty) == (
  dcl discountedPrice : Price := price;
  if volumeDiscounts <> { |-> }
  then (*@\vdmnotcovered{(}@*)
   (*@\vdmnotcovered{for}@*) all quantity in set dom (*@\vdmnotcovered{volumeDiscounts}@*)
    do (*@\vdmnotcovered{(}@*)
     if (qty >= quantity and discountedPrice > volumeDiscounts((*@\vdmnotcovered{quantity}@*)))
     then discountedPrice := (*@\vdmnotcovered{volumeDiscounts}@*)((*@\vdmnotcovered{quantity}@*));
    );
   );
  return discountedPrice;
 )
 post RESULT <= price;

end Product
\end{vdmpp}
\bigskip
\begin{longtable}{|l|r|r|r|}
\hline
Function or operation & Line & Coverage & Calls \\
\hline
\hline
\hyperref[Product:26]{Product} & 26&100.0\% & 62 \\
\hline
\hyperref[addToStock:62]{addToStock} & 62&100.0\% & 49 \\
\hline
\hyperref[getPriceWithDiscount:69]{getPriceWithDiscount} & 69&39.2\% & 28 \\
\hline
\hyperref[removeFromStock:54]{removeFromStock} & 54&100.0\% & 26 \\
\hline
\hyperref[setVolumeDiscounts:48]{setVolumeDiscounts} & 48&0.0\% & 0 \\
\hline
\hline
Product.vdmpp & & 71.0\% & 165 \\
\hline
\end{longtable}

